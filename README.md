# SolSA

The SolSA library for Node.js makes it possible to specify the architecture of
cloud-native solutions as programs. Using SolSA, a developer can enumerate and
configure all the components of a solution including resources such as managed
cloud services, cloud functions, containerized services, Knative services and
event sources.

SolSA leverages Kubernetes operators to define and configure these resources
whether they run inside or outside of a Kubernetes cluster. SolSA relies on the
[composable operator](https://github.ibm.com/seed/composable) to encode dynamic
dependencies between resource configurations.

The execution of the SolSA code produces yaml than can be fed directly into
`kubectl` to deploy the solution. SolSA leverages
[Kustomize](https://github.com/kubernetes-sigs/kustomize) to permit targeting
multiple environments, e.g., local development cluster, IKS or ICP cluster.

SolSA enables the specification of repeatable architectural patterns that can be
reused across many solutions. SolSA supports expressing dependencies on shared
resources. SolSA simplifies the configuration of related resources such as a
Kafka instance, a Kafka topic, and a Knative Kafka event source.

The SolSA code is much more compact and less error-prone than the equivalent
yaml. The yaml generated by SolSA can be deployed at once, i.e., with a single
`kubectl apply` command. There is no need for separate steps or manual inputs
during deployment.

SolSA includes an optional capability to containerize Node.js code. This
facilitates the integration of components that require a little bit of glue code
to interface properly, e.g., to align schemas or match protocols. This glue code
can leverage portable Node.js frameworks such as
[Express](https://expressjs.com) or [KafkaJS](https://kafka.js.org). SolSA
builds the container image and synthesizes the yaml to instantiate the image
with the proper configuration.

## Components

SolSA consists of:
- A main `solsa` Node.js module that provides a library of high-level
  abstractions for defining the software architecture of a solution.
- A `solsa` command-line interface (CLI):
  - `solsa build` builds container images for SolSA-defined services (if any).
  - `solsa push` pushes container images for SolSA-defined services (if any).
  - `solsa yaml` synthesizes yaml for deploying SolSA solutions on Kubernetes.

## Configure a Kubernetes Cluster for SolSA

Note: If you are installing SolSA on an IKS cluster, we assume your cluster is
already properly configured to enable you to pull images from the IBM Container
Registry.  If it is not, please see the instructions at
https://cloud.ibm.com/docs/containers?topic=containers-images. 

We assume that you have already configured `kubectl` to be able to access each
Kubernetes cluster you will be using with SolSA.

We assume you have cloned this git repository to your development machine.
```shell
git clone https://github.ibm.com/solsa/solsa.git
```
We will use `$SOLSA_ROOT` to indicate the root of your clone of this repository
in the instructions below.


### Cluster-wide Setup

1. Install SEED operators from https://github.ibm.com/seed/charts.

2. Install the Composable operator from https://github.ibm.com/seed/composable.

3. Optionally install Knative. For IKS, follow the instructions at
   https://cloud.ibm.com/docs/containers?topic=containers-serverless-apps-knative.

4. Optionally install the Kafka Knative Event Source from
   https://github.com/knative/eventing-sources/tree/master/contrib/kafka/samples.

### Per Namespace Setup

1. Run for each namespace:
```shell
install/install.sh -n mynamespace
```

## Local Setup

1. Create a `.solsa.yaml` file in your home directory that describes each
   Kubernetes context for which you want SolSA to generate a Kustomize overlay.
   The example file below defines two deployment contexts, a local development
   environment provided by Docker Desktop that uses a NodePort ingress and an
   IKS cluster.
   ```yaml
   contexts:
   - name: 'docker-for-desktop'
     ingress:
       nodePort: 32323
   - name: 'mycluster'
     ingress:
       iks:
         subdomain: 'mycluster123.us-east.containers.appdomain.cloud'
         tlssecret: 'mycluster123'
     registry: 'us.icr.io/tardieu'
     images:
     - name: solsa-translator
       newName: us.icr.io/groved/solsa-translator
   ```
   The IKS context definition demonstrates how to instruct SolSA to generate a
   Kustomize overlay that will rename docker images so that instead of being
   pulled from the local registry on the dev machine, the images will instead be
   pulled from a specific namespace in the IBM Container Registry. Specific
   images can also be handled. A default registry can also be specified.

2. Install the SolSA npm module

```sh
cd $SOLSA_ROOT
npm install --prod
npm link
```

## Examples

The [solsa-examples](https://github.ibm.com/solsa/solsa-examples) repository
contains sample cloud native applications and architectural patterns defined
using SolSA.

A SolSA application `myApp.js` can be built and deployed to the current
Kubernetes context using the `solsa` CLI and `kubectl` as shown below.
```shell
solsa build myApp.js
solsa push myApp.js
solsa yaml myApp.js | kubectl apply -f -
```
To undeploy the application, use the command:
```shell
solsa yaml myApp.js | kubectl delete -f -
```
